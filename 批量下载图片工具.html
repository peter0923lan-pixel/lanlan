<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡ä¸‹è½½å›¾ç‰‡å¹¶æ’å…¥Excelå·¥å…·</title>
    <!-- ExcelJS åº“ - ä½¿ç”¨å¤šä¸ªå¤‡ç”¨CDNç¡®ä¿åŠ è½½æˆåŠŸ -->
    <script>
        // åŠ¨æ€åŠ è½½ExcelJSåº“ï¼Œæ”¯æŒå¤šä¸ªå¤‡ç”¨CDN
        (function() {
            const cdnSources = [
                'https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js',
                'https://unpkg.com/exceljs@4.4.0/dist/exceljs.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js'
            ];

            let currentIndex = 0;
            let loading = false;

            function loadExcelJS() {
                if (loading) return;
                if (typeof ExcelJS !== 'undefined') {
                    console.log('ExcelJSå·²åŠ è½½');
                    updateLoadingStatus('loaded', 'âœ“ ExcelJSåº“åŠ è½½æˆåŠŸï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨');
                    hideLibraryError();
                    return;
                }

                if (currentIndex >= cdnSources.length) {
                    updateLoadingStatus('error', 'âœ— æ‰€æœ‰CDNæºéƒ½æ— æ³•åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    showLibraryError();
                    return;
                }

                // æ›´æ–°åŠ è½½çŠ¶æ€
                if (currentIndex > 0) {
                    updateLoadingStatus('', 'æ­£åœ¨å°è¯•å¤‡ç”¨CDNæº ' + (currentIndex + 1) + '/' + cdnSources.length + '...');
                }

                loading = true;
                const script = document.createElement('script');
                script.src = cdnSources[currentIndex];
                
                script.onload = function() {
                    loading = false;
                    // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿ExcelJSå¯¹è±¡å·²å®šä¹‰
                    setTimeout(function() {
                        if (typeof ExcelJS !== 'undefined') {
                            console.log('ExcelJSåŠ è½½æˆåŠŸï¼æ¥æºï¼š' + cdnSources[currentIndex]);
                            updateLoadingStatus('loaded', 'âœ“ ExcelJSåº“åŠ è½½æˆåŠŸï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨');
                            hideLibraryError();
                        } else {
                            currentIndex++;
                            loadExcelJS();
                        }
                    }, 100);
                };

                script.onerror = function() {
                    loading = false;
                    console.log('CDNåŠ è½½å¤±è´¥ï¼š' + cdnSources[currentIndex]);
                    currentIndex++;
                    loadExcelJS();
                };

                document.head.appendChild(script);
            }

            // é¡µé¢åŠ è½½åå¼€å§‹åŠ è½½ExcelJS
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadExcelJS);
            } else {
                loadExcelJS();
            }

            // æš´éœ²ç»™å…¨å±€ä½¿ç”¨
            window.loadExcelJSFallback = loadExcelJS;
        })();
    </script>
    <script>

        function updateLoadingStatus(status, message) {
            const statusDiv = document.getElementById('loadingStatus');
            if (!statusDiv) return;

            statusDiv.className = 'loading-status ' + status;
            if (status === 'loaded') {
                statusDiv.innerHTML = '<span>âœ“</span><span>' + message + '</span>';
            } else if (status === 'error') {
                statusDiv.innerHTML = '<span>âœ—</span><span>' + message + '</span>';
            } else {
                statusDiv.innerHTML = '<div class="spinner"></div><span>' + message + '</span>';
            }
        }

        function showLibraryError() {
            updateLoadingStatus('error', 'âœ— ExcelJSåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            const errorDiv = document.createElement('div');
            errorDiv.id = 'libraryError';
            errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; max-width: 600px; text-align: center;';
            errorDiv.innerHTML = `
                <h3 style="margin-bottom: 10px;">âš ï¸ ExcelJSåº“åŠ è½½å¤±è´¥</h3>
                <p style="margin-bottom: 15px;">æ— æ³•ä»CDNåŠ è½½ExcelJSåº“ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ã€‚</p>
                <p style="margin-bottom: 15px; font-size: 14px;">è§£å†³æ–¹æ¡ˆï¼š</p>
                <ol style="text-align: left; display: inline-block; margin-bottom: 15px;">
                    <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                    <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                    <li>ä½¿ç”¨VPNæˆ–ä»£ç†</li>
                    <li>ç¡®ä¿å¯ä»¥è®¿é—®CDNæœåŠ¡</li>
                </ol>
                <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">åˆ·æ–°é¡µé¢</button>
                <button onclick="document.getElementById('libraryError').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
            `;
            document.body.appendChild(errorDiv);
        }

        function hideLibraryError() {
            const errorDiv = document.getElementById('libraryError');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #667eea;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
        }

        #fileInput {
            display: none;
        }

        .config-section {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-title {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .config-item {
            margin-bottom: 15px;
        }

        .config-item label {
            display: block;
            color: #555;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .config-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .config-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-top: 20px;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .log {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: #333;
            line-height: 1.6;
        }

        .log-item {
            margin-bottom: 5px;
        }

        .log-item.success {
            color: #28a745;
        }

        .log-item.error {
            color: #dc3545;
        }

        .log-item.info {
            color: #17a2b8;
        }

        .file-info {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.active {
            display: block;
        }

        .file-info strong {
            color: #2e7d32;
        }

        .loading-status {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #0c5460;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-status.loaded {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .loading-status.error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #17a2b8;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¥ æ‰¹é‡ä¸‹è½½å›¾ç‰‡å¹¶æ’å…¥Excel</h1>
        <p class="subtitle">æ— éœ€å®‰è£…ç¯å¢ƒï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨</p>

        <div class="loading-status" id="loadingStatus">
            <div class="spinner"></div>
            <span>æ­£åœ¨åŠ è½½ExcelJSåº“...</span>
        </div>

        <div class="file-info" id="fileInfo">
            <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong><span id="fileName"></span>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„</div>
            <div class="upload-hint">æ”¯æŒ .xlsx æ ¼å¼æ–‡ä»¶</div>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
        </div>

        <div class="config-section">
            <div class="config-title">âš™ï¸ é…ç½®é€‰é¡¹</div>
            <div class="config-item">
                <label for="imageColumn">å›¾ç‰‡URLåˆ—åï¼š</label>
                <input type="text" id="imageColumn" value="å›¾ç‰‡æ¶ˆæ¯å†…å®¹" placeholder="ä¾‹å¦‚ï¼šå›¾ç‰‡æ¶ˆæ¯å†…å®¹">
            </div>
            <div class="config-item">
                <label for="targetColumn">ç›®æ ‡åˆ—ï¼ˆæ’å…¥å›¾ç‰‡çš„åˆ—ï¼‰ï¼š</label>
                <input type="text" id="targetColumn" value="N" placeholder="ä¾‹å¦‚ï¼šN" maxlength="2">
            </div>
            <div class="config-item">
                <label for="imageHeight">å›¾ç‰‡é«˜åº¦ï¼ˆåƒç´ ï¼‰ï¼š</label>
                <input type="number" id="imageHeight" value="100" min="50" max="500" placeholder="ä¾‹å¦‚ï¼š100">
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; font-size: 12px; color: #856404;">
                <strong>âš ï¸ æç¤ºï¼š</strong>å¦‚æœé‡åˆ°è·¨åŸŸé—®é¢˜ï¼Œå›¾ç‰‡å¯èƒ½æ— æ³•ä¸‹è½½ã€‚è¯·ç¡®ä¿å›¾ç‰‡URLæ”¯æŒè·¨åŸŸè®¿é—®ï¼ˆCORSï¼‰ã€‚
            </div>
        </div>

        <button class="btn" id="processBtn" disabled>ğŸš€ å¼€å§‹å¤„ç†</button>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const log = document.getElementById('log');

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // æ‹–æ‹½äº‹ä»¶
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸º.xlsæ ¼å¼
            if (file.name.match(/\.xls$/i) && !file.name.match(/\.xlsx$/i)) {
                const confirm = window.confirm('æ£€æµ‹åˆ°.xlsæ ¼å¼æ–‡ä»¶ã€‚\n\næ³¨æ„ï¼šæ­¤å·¥å…·ä¸»è¦æ”¯æŒ.xlsxæ ¼å¼ã€‚\nå¦‚æœå¤„ç†å¤±è´¥ï¼Œè¯·ä½¿ç”¨Excelå°†æ–‡ä»¶å¦å­˜ä¸º.xlsxæ ¼å¼åå†è¯•ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ');
                if (!confirm) {
                    return;
                }
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.classList.add('active');
            processBtn.disabled = false;
            addLog('æ–‡ä»¶å·²é€‰æ‹©ï¼š' + file.name, 'success');
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            // å¤„ç†å¤šè¡Œæ¶ˆæ¯
            const lines = message.split('\n');
            lines.forEach((line, index) => {
                if (index > 0) {
                    const br = document.createElement('br');
                    logItem.appendChild(br);
                }
                const textNode = document.createTextNode(index === 0 ? `[${new Date().toLocaleTimeString()}] ${line}` : line);
                logItem.appendChild(textNode);
            });
            log.appendChild(logItem);
            log.scrollTop = log.scrollHeight;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressFill.style.width = percent + '%';
            progressFill.textContent = `${percent}% (${current}/${total})`;
        }

        // ä¸‹è½½å›¾ç‰‡ï¼ˆä½¿ç”¨ä»£ç†æˆ–ç›´æ¥ä¸‹è½½ï¼‰
        async function downloadImage(url) {
            try {
                // å°è¯•ç›´æ¥ä¸‹è½½
                let response;
                try {
                    response = await fetch(url, {
                        mode: 'cors',
                        credentials: 'omit',
                        referrerPolicy: 'no-referrer'
                    });
                } catch (corsError) {
                    // å¦‚æœCORSå¤±è´¥ï¼Œæä¾›è¯¦ç»†è¯´æ˜
                    if (corsError.name === 'TypeError' && corsError.message.includes('Failed to fetch')) {
                        throw new Error('è·¨åŸŸé™åˆ¶ï¼šå›¾ç‰‡æœåŠ¡å™¨ä¸å…è®¸è·¨åŸŸè®¿é—®ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨æ”¯æŒCORSçš„å›¾ç‰‡URL\n2. å°†å›¾ç‰‡ä¸Šä¼ åˆ°æ”¯æŒCORSçš„å›¾åºŠï¼ˆå¦‚imgurã€sm.msç­‰ï¼‰\n3. ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ç¨‹åºï¼ˆå¦‚CORS Unblockï¼‰');
                    }
                    throw corsError;
                }

                if (!response.ok) {
                    if (response.status === 0) {
                        throw new Error('è·¨åŸŸé™åˆ¶ï¼šæ— æ³•è®¿é—®è¯¥å›¾ç‰‡URL');
                    }
                    throw new Error(`HTTP ${response.status} ${response.statusText}`);
                }

                const blob = await response.blob();
                
                // éªŒè¯æ˜¯å¦ä¸ºå›¾ç‰‡
                if (!blob.type.startsWith('image/')) {
                    // å¦‚æœMIMEç±»å‹æœªçŸ¥ï¼Œå°è¯•é€šè¿‡URLåˆ¤æ–­
                    const urlLower = url.toLowerCase();
                    if (!urlLower.match(/\.(jpg|jpeg|png|gif|webp|bmp)(\?|$)/i)) {
                        throw new Error('ä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯å›¾ç‰‡æ ¼å¼');
                    }
                    // å¦‚æœURLçœ‹èµ·æ¥æ˜¯å›¾ç‰‡ï¼Œç»§ç»­å¤„ç†
                }

                return blob;
            } catch (error) {
                if (error.message.includes('è·¨åŸŸ')) {
                    throw error;
                }
                throw new Error(`ä¸‹è½½å¤±è´¥: ${error.message}`);
            }
        }

        // å°†Blobè½¬æ¢ä¸ºBase64å¹¶è·å–å›¾ç‰‡æ ¼å¼
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result;
                    // æ£€æµ‹å›¾ç‰‡æ ¼å¼
                    let extension = 'jpeg';
                    if (blob.type.includes('png')) {
                        extension = 'png';
                    } else if (blob.type.includes('gif')) {
                        extension = 'gif';
                    } else if (blob.type.includes('webp')) {
                        extension = 'webp';
                    }
                    resolve({ base64, extension });
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // å¤„ç†Excelæ–‡ä»¶
        processBtn.addEventListener('click', async () => {
            // é¦–å…ˆæ£€æŸ¥ExcelJSæ˜¯å¦å·²åŠ è½½
            if (typeof ExcelJS === 'undefined') {
                alert('ExcelJSåº“æœªåŠ è½½ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. CDNæ— æ³•è®¿é—®\n\nè¯·å°è¯•ï¼š\n1. åˆ·æ–°é¡µé¢\n2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n3. ä½¿ç”¨VPNæˆ–ä»£ç†');
                // å°è¯•åŠ è½½å¤‡ç”¨CDN
                loadExcelJSFallback();
                return;
            }

            if (!selectedFile) {
                alert('è¯·å…ˆé€‰æ‹©Excelæ–‡ä»¶');
                return;
            }

            // è·å–é…ç½®
            const imageColumnName = document.getElementById('imageColumn').value.trim();
            const targetColumn = document.getElementById('targetColumn').value.trim().toUpperCase();
            const imageHeight = parseInt(document.getElementById('imageHeight').value) || 100;

            if (!imageColumnName) {
                alert('è¯·è¾“å…¥å›¾ç‰‡URLåˆ—å');
                return;
            }

            if (!targetColumn || targetColumn.length > 2) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡åˆ—ï¼ˆå¦‚ï¼šNï¼‰');
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            processBtn.disabled = true;
            progressSection.classList.add('active');
            log.innerHTML = '';
            addLog('å¼€å§‹å¤„ç†Excelæ–‡ä»¶...', 'info');

            try {
                // è¯»å–Excelæ–‡ä»¶
                const arrayBuffer = await selectedFile.arrayBuffer();
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(arrayBuffer);

                const worksheet = workbook.getWorksheet(1); // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                if (!worksheet) {
                    throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨');
                }

                addLog('Excelæ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');

                // æŸ¥æ‰¾å›¾ç‰‡URLåˆ—
                let imageColIndex = null;
                const headerRow = worksheet.getRow(1);
                headerRow.eachCell((cell, colNumber) => {
                    if (cell.value && String(cell.value).trim() === imageColumnName) {
                        imageColIndex = colNumber;
                    }
                });

                if (!imageColIndex) {
                    throw new Error(`æœªæ‰¾åˆ°åˆ— "${imageColumnName}"`);
                }

                const imageColLetter = worksheet.getColumn(imageColIndex).letter;
                addLog(`æ‰¾åˆ°å›¾ç‰‡URLåˆ—: ${imageColLetter}`, 'success');

                // è·å–ç›®æ ‡åˆ—ç´¢å¼•
                let targetColIndex;
                if (targetColumn.length === 1) {
                    targetColIndex = targetColumn.charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                } else {
                    // å¤„ç†AA, ABç­‰åˆ—
                    targetColIndex = (targetColumn.charCodeAt(0) - 'A'.charCodeAt(0) + 1) * 26 + 
                                   (targetColumn.charCodeAt(1) - 'A'.charCodeAt(0) + 1);
                }

                const targetColLetter = worksheet.getColumn(targetColIndex).letter;
                addLog(`ç›®æ ‡åˆ—: ${targetColLetter}`, 'success');

                // ç»Ÿè®¡éœ€è¦å¤„ç†çš„è¡Œæ•°
                let totalRows = 0;
                for (let row = 2; row <= worksheet.rowCount; row++) {
                    const cell = worksheet.getCell(row, imageColIndex);
                    if (cell.value && String(cell.value).trim()) {
                        totalRows++;
                    }
                }

                if (totalRows === 0) {
                    throw new Error('æœªæ‰¾åˆ°éœ€è¦å¤„ç†çš„å›¾ç‰‡URL');
                }

                addLog(`å…±æ‰¾åˆ° ${totalRows} è¡Œéœ€è¦å¤„ç†`, 'info');

                // å¤„ç†æ¯ä¸€è¡Œ
                let successCount = 0;
                let failCount = 0;
                let processedCount = 0;

                for (let row = 2; row <= worksheet.rowCount; row++) {
                    const cell = worksheet.getCell(row, imageColIndex);
                    const imageUrl = cell.value ? String(cell.value).trim() : '';

                    if (!imageUrl) {
                        continue;
                    }

                    addLog(`ç¬¬ ${row} è¡Œ: å¤„ç†å›¾ç‰‡ ${imageUrl.substring(0, 50)}...`, 'info');

                    try {
                        // ä¸‹è½½å›¾ç‰‡
                        const imageBlob = await downloadImage(imageUrl);
                        
                        // è½¬æ¢ä¸ºBase64å¹¶è·å–æ ¼å¼
                        const { base64, extension } = await blobToBase64(imageBlob);
                        
                        // ExcelJSæ”¯æŒçš„æ ¼å¼ï¼špng, jpeg, gif
                        let finalBase64 = base64;
                        let excelExtension = extension;
                        
                        if (extension === 'webp') {
                            // WebPéœ€è¦è½¬æ¢ä¸ºPNGï¼ˆé€šè¿‡Canvasï¼‰
                            excelExtension = 'png';
                            const img = new Image();
                            const pngBase64 = await new Promise((resolve, reject) => {
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0);
                                    canvas.toBlob((blob) => {
                                        blobToBase64(blob).then(({ base64: pngBase64 }) => {
                                            resolve(pngBase64);
                                        }).catch(reject);
                                    }, 'image/png');
                                };
                                img.onerror = reject;
                                img.src = base64;
                            });
                            finalBase64 = pngBase64;
                        }
                        
                        // è®¡ç®—å›¾ç‰‡å®½åº¦ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
                        const imgForSize = new Image();
                        await new Promise((resolve, reject) => {
                            imgForSize.onload = resolve;
                            imgForSize.onerror = reject;
                            imgForSize.src = finalBase64;
                        });
                        const aspectRatio = imgForSize.width / imgForSize.height;
                        const imageWidth = imageHeight * aspectRatio;
                        
                        // åˆ›å»ºå›¾ç‰‡å¯¹è±¡
                        const imageId = workbook.addImage({
                            base64: finalBase64.split(',')[1], // ç§»é™¤data:image/...;base64,å‰ç¼€
                            extension: excelExtension
                        });

                        // æ’å…¥å›¾ç‰‡
                        worksheet.addImage(imageId, {
                            tl: { col: targetColIndex - 1, row: row - 1 },
                            ext: { width: imageWidth, height: imageHeight }
                        });

                        // è°ƒæ•´è¡Œé«˜
                        worksheet.getRow(row).height = imageHeight + 10;

                        addLog(`ç¬¬ ${row} è¡Œ: å›¾ç‰‡å·²æ’å…¥åˆ° ${targetColLetter}${row}`, 'success');
                        successCount++;
                    } catch (error) {
                        addLog(`ç¬¬ ${row} è¡Œ: å¤„ç†å¤±è´¥ - ${error.message}`, 'error');
                        failCount++;
                    }

                    processedCount++;
                    updateProgress(processedCount, totalRows);

                    // é¿å…è¯·æ±‚è¿‡å¿«
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                addLog(`\nå¤„ç†å®Œæˆï¼æˆåŠŸ: ${successCount} å¼ ï¼Œå¤±è´¥: ${failCount} å¼ `, 'info');

                // ä¿å­˜æ–‡ä»¶
                addLog('æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶...', 'info');
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                // ä¸‹è½½æ–‡ä»¶
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = selectedFile.name.replace(/\.(xlsx|xls)$/i, '_å·²æ’å…¥å›¾ç‰‡.xlsx');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                addLog('æ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼', 'success');
                processBtn.disabled = false;

            } catch (error) {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
                alert(`å¤„ç†å¤±è´¥: ${error.message}`);
                processBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

